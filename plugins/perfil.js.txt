import fetch from 'node-fetch'

let handler = async (m, { conn }) => {
  const db = global.db || { data: { users: {} } }
  const parsed = await Promise.resolve(conn.parseMention?.(m.text || ''))
  const mention0 = (Array.isArray(m.mentionedJid) && m.mentionedJid[0]) || (Array.isArray(parsed) && parsed[0])
  const rawTarget = mention0 || m?.quoted?.sender || m.sender
  const target = (conn.normalizeJid ? conn.normalizeJid(rawTarget) : rawTarget)
  const userObj = (db.data.users && db.data.users[target]) || {}

  const mentionedJid = [...new Set([m.sender, target].filter(Boolean).map(j => (conn.normalizeJid ? conn.normalizeJid(j) : j)))]

  const number = String(target || '').split('@')[0]
  let wName = ''
  try { wName = await Promise.resolve(conn.getName?.(target)) } catch {}
  const regName = (userObj?.registered && userObj?.name) ? userObj.name : ''
  const name = regName || wName || (target === m.sender ? (m.pushName) : '') || `@${number}`
  const age = userObj.age ?? null
  
  // OBTENER MONEDAS - USANDO [ğ™¶ğšğ™´ğ™¼ğ™»ğ™¸ğ™½ğš‚]
  const coin = userObj.coin ?? userObj.bank ?? userObj.yenes ?? userObj.money ?? userObj.moneda ?? 0
  
  let sn = userObj.sn
  if (!sn) {
    sn = 'SN-' + Math.random().toString(36).slice(2, 6).toUpperCase() + '-' + Math.floor(1000 + Math.random() * 9000)
    try { if (db.data.users[target]) db.data.users[target].sn = sn } catch {}
  }

  // Obtener nivel y experiencia
  const nivel = userObj.level ?? 0
  const exp = userObj.exp ?? 0
  const expNeeded = nivel * 100 + 100 // FÃ³rmula simple para siguiente nivel
  const porcentajeNivel = nivel > 0 ? Math.min(100, (exp / expNeeded) * 100) : 0
  
  // Crear barra de progreso
  const barLength = 10
  const filled = Math.round((porcentajeNivel / 100) * barLength)
  const barraProgreso = 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(barLength - filled)
  
  // Determinar rango basado en nivel
  let rango = 'ğŸŸ¢ ğ™½ğ™¾ğš…ğ™°ğšƒğ™¾'
  let emblema = 'ğŸŒ±'
  if (nivel >= 50) {
    rango = 'ğŸ”´ ğ™¼ğ™°ğ™´ğš‚ğšƒğšğ™¾'
    emblema = 'ğŸ‘‘'
  } else if (nivel >= 30) {
    rango = 'ğŸŸ£ ğ™´ğš‡ğ™¿ğ™´ğšğšƒğ™¾'
    emblema = 'â­'
  } else if (nivel >= 15) {
    rango = 'ğŸ”µ ğ™°ğš…ğ™°ğ™½ğš‰ğ™°ğ™³ğ™¾'
    emblema = 'ğŸ¯'
  } else if (nivel >= 5) {
    rango = 'ğŸŸ¡ ğ™¸ğ™½ğšƒğ™´ğšğ™¼ğ™´ğ™³ğ™¸ğ™¾'
    emblema = 'âš¡'
  }

  // EstadÃ­sticas adicionales
  const partidas_jugadas = userObj.gamesPlayed ?? userObj.partidas ?? 0
  const partidas_ganadas = userObj.gamesWon ?? userObj.victorias ?? 0
  const porcentajeVictorias = partidas_jugadas > 0 ? Math.round((partidas_ganadas / partidas_jugadas) * 100) : 0
  const racha = userObj.streak ?? userObj.racha ?? 0

  // Crear mensaje de perfil con diseÃ±o visual
  const perfilMessage = `> âš™ï¸ *ğ™¿ğ™´ğšğ™µğ™¸ğ™» ğ™³ğ™´ ${name.toUpperCase()}* âš™ï¸
> ${emblema} ${rango} â€¢ ${sn}

ğŸ“Š *ğ™´ğš‚ğšƒğ™°ğ™³ğ™¸ğš‚ğšƒğ™¸ğ™²ğ™°ğš‚*
â”œâ”€ğŸ“ˆ ğ™½ğ™¸ğš…ğ™´ğ™»: ${nivel} | âš¡ ${exp}ğš‡ğ™¿
â”œâ”€ğŸ“Š ğ™¿ğšğ™¾ğ™¶ğšğ™´ğš‚ğ™¾: ${barraProgreso} ${Math.round(porcentajeNivel)}%
â”œâ”€ğŸ® ğ™¿ğ™°ğšğšƒğ™¸ğ™³ğ™°ğš‚: ${partidas_jugadas}ğ™¹ | âœ… ${partidas_ganadas}ğ™¶
â”œâ”€ğŸ¯ ğ™´ğ™µğ™¸ğ™²ğ™°ğ™²ğ™¸ğ™°: ${porcentajeVictorias}% | ğŸ”¥ ${racha}ğš

ğŸ’° *ğ™´ğ™²ğ™¾ğ™½ğ™¾ğ™¼ğ™¸ğ™°*
â”œâ”€ğŸ§Œ [ğ™¶ğšğ™´ğ™¼ğ™»ğ™¸ğ™½ğš‚]: ${coin.toLocaleString()}
â”œâ”€ğŸ¦ ğ™±ğ™°ğ™½ğ™²ğ™¾: ${userObj.bank ?? coin} [ğ™¶ğšğ™´ğ™¼ğ™»ğ™¸ğ™½ğš‚]

ğŸ‘¤ *ğ™¿ğ™´ğšğš‚ğ™¾ğ™½ğ™°ğ™»*
â”œâ”€ğŸ“± ğ™½ğš„Ìğ™¼ğ™´ğšğ™¾: wa.me/${number}
â”œâ”€ğŸ“ ğšğ™´ğ™¶ğ™¸ğš‚ğšƒğšğ™¾: ${userObj.registered ? 'âœ…' : 'âŒ'}
â”œâ”€ğŸ‚ ğ™´ğ™³ğ™°ğ™³: ${age ? age + ' ğšŠÃ±ğš˜ğšœ' : 'ğ™½ğš˜ ğš›ğšğšğš’ğšœğšğš›ğšŠğšğšŠ'}`

  const fkontak = await makeFkontak()

  await conn.sendMessage(
    m.chat,
    { 
      text: perfilMessage,
      mentions: mentionedJid
    },
    { quoted: fkontak || m }
  )
}

handler.help = ['perfil']
handler.tags = ['tools']
handler.command = /^perfil$/i
handler.exp = 5
handler.register = true

export default handler

async function makeFkontak() {
  try {
    const res = await fetch('https://image2url.com/images/1765504298320-250ed158-9ddc-49d9-942b-2edfcc711cc8.jpg')
    const thumb2 = Buffer.from(await res.arrayBuffer())
    return {
      key: { participant: '0@s.whatsapp.net', remoteJid: 'status@broadcast', fromMe: false, id: 'Halo' },
      message: { locationMessage: { name: `ğŸ“‡ ğ™¿ğ™´ğšğ™µğ™¸ğ™»`, jpegThumbnail: thumb2 } },
      participant: '0@s.whatsapp.net'
    }
  } catch {
    return null
  }
}